name: Deploy to InfinityFree

# Trigger deployment on push to main branch
on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allow manual trigger

# Environment variables for the entire workflow
env:
  NODE_VERSION: '20'

jobs:
  deploy:
    name: Build and Deploy to InfinityFree
    runs-on: ubuntu-latest

    steps:
    # Checkout the repository
    - name: ğŸš€ Checkout Repository
      uses: actions/checkout@v4

    # Setup Node.js environment
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    # Install dependencies
    - name: ğŸ“¦ Install Dependencies
      run: npm ci

    # Run linting checks
    - name: ğŸ” Run Code Quality Checks
      run: |
        npm run lint || echo "Linting completed with warnings"

    # Build the project
    - name: ğŸ”¨ Build Project
      run: npm run build

    # Verify build output
    - name: âœ… Verify Build Output
      run: |
        echo "Build directory contents:"
        ls -la dist/
        echo "Total build size:"
        du -sh dist/

    # Deploy to InfinityFree via FTP
    - name: ğŸš€ Deploy to InfinityFree
      env:
        FTP_HOST: ${{ secrets.FTP_HOST }}
        FTP_USER: ${{ secrets.FTP_USER }}
        FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        FTP_REMOTE_DIR: ${{ secrets.FTP_REMOTE_DIR }}
        FTP_PORT: ${{ secrets.FTP_PORT }}
        FTP_SECURE: ${{ secrets.FTP_SECURE }}
      run: |
        echo "ğŸ”— Connecting to FTP server: $FTP_HOST"
        node scripts/deploy-ftp.js

    # Notify deployment status
    - name: ğŸ“¢ Deployment Status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Your site should be live at your InfinityFree domain"
        else
          echo "âŒ Deployment failed. Check the logs above for details."
          exit 1
        fi

  # Optional: Create a deployment artifact for manual inspection
  create-artifact:
    name: Create Deployment Artifact
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' # Only for manual triggers

    steps:
    - name: ğŸš€ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ Install Dependencies
      run: npm ci

    - name: ğŸ”¨ Build Project
      run: npm run build

    - name: ğŸ“ Create Deployment Artifact
      uses: actions/upload-artifact@v4
      with:
        name: portfolio-build-${{ github.sha }}
        path: dist/
        retention-days: 30

    - name: ğŸ“‹ Artifact Info
      run: |
        echo "âœ… Build artifact created successfully!"
        echo "ğŸ“¦ Artifact name: portfolio-build-${{ github.sha }}"
        echo "ğŸ• Retention: 30 days"
